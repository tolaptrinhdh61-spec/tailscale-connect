name: Tailscale Hostname Test

on:
  workflow_dispatch:

jobs:
  # Job 1: Server runner vá»›i hostname cá»‘ Ä‘á»‹nh
  server-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Tailscale with fixed hostname
        run: |
          # CÃ i tá»« package manager
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y tailscale

          # Connect vá»›i hostname cá»‘ Ä‘á»‹nh: svr-runner
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=svr-runner
          sleep 5

      - name: Get Tailscale info
        run: |
          TS_IP=$(tailscale ip -4)
          TS_HOSTNAME=$(tailscale status --self | awk '{print $2}')
          echo "ğŸ–¥ï¸  Server Hostname: $TS_HOSTNAME"
          echo "ğŸ–¥ï¸  Server IP: $TS_IP"

      - name: Setup SSH Server
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y openssh-server rsync

          # Táº¡o user vÃ  password
          echo "runner:testpass123" | sudo chpasswd

          # Configure SSH
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

          echo "âœ“ SSH server started"

      - name: Create test data
        run: |
          mkdir -p ~/server-data
          echo "Hello from Server (svr-runner)" > ~/server-data/server-file.txt
          echo "Server timestamp: $(date)" > ~/server-data/timestamp.txt
          echo "Hostname: $(hostname)" > ~/server-data/hostname.txt
          echo "Random data: $RANDOM-$RANDOM-$RANDOM" > ~/server-data/random.txt
          dd if=/dev/urandom of=~/server-data/binary-test.dat bs=1M count=5 2>/dev/null

          ls -lh ~/server-data/
          echo "âœ“ Test files created"

      - name: Show network info
        run: |
          echo "=== Tailscale Status ==="
          sudo tailscale status
          echo ""
          echo "=== Hostname Info ==="
          echo "System hostname: $(hostname)"
          echo "Tailscale hostname: svr-runner"
          echo ""
          echo "=== IP Addresses ==="
          ip addr show tailscale0
          echo ""
          echo "=== SSH Status ==="
          sudo netstat -tlnp | grep ssh || echo "SSH not in netstat yet (OK)"
          sudo systemctl status ssh --no-pager | head -5 || true

      - name: Keep server alive and monitor
        run: |
          echo "ğŸŸ¢ Server 'svr-runner' is ready!"
          echo "Hostname: svr-runner"
          echo "IP: $(tailscale ip -4)"
          echo "Monitoring for 20 minutes..."

          START_TIME=$(date +%s)
          CLIENT_CONNECTED=false

          for i in {1..240}; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            # Kiá»ƒm tra peers má»—i 30 giÃ¢y
            if [ $((i % 6)) -eq 0 ]; then
              echo "â±ï¸  [$ELAPSED seconds] Checking for cli-runner..."
              
              # TÃ¬m client theo hostname
              if sudo tailscale status | grep -q 'cli-runner'; then
                if [ "$CLIENT_CONNECTED" = false ]; then
                  echo "ğŸ‰ Client 'cli-runner' connected!"
                  CLIENT_CONNECTED=true
                fi
                echo "âœ“ cli-runner is online"
              fi
            fi
            
            # Kiá»ƒm tra file Ä‘Æ°á»£c sync Ä‘áº¿n
            if [ -d ~/client-data ] && [ "$(ls -A ~/client-data 2>/dev/null)" ]; then
              if [ "$CLIENT_CONNECTED" = false ]; then
                echo "ğŸ“¥ Received files from cli-runner!"
                ls -lh ~/client-data/
                CLIENT_CONNECTED=true
              fi
            fi
            
            sleep 5
          done

          echo "â° Monitoring timeout reached"

      - name: Show final results
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š SERVER (svr-runner) FINAL STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Hostname: svr-runner"
          echo "IP: $(tailscale ip -4)"
          echo ""
          echo "=== Files in server-data (original) ==="
          ls -lh ~/server-data/ 2>/dev/null || echo "No files"
          echo ""
          echo "=== Files received from cli-runner ==="
          if [ -d ~/client-data ]; then
            ls -lh ~/client-data/
            echo ""
            echo "Content of received text files:"
            cat ~/client-data/*.txt 2>/dev/null || echo "No text files"
          else
            echo "âŒ No files received from client"
          fi
          echo ""
          echo "=== Tailscale peers ==="
          sudo tailscale status --peers || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # Job 2: Client runner vá»›i hostname cá»‘ Ä‘á»‹nh
  client-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for server startup
        run: |
          echo "â³ Waiting 45 seconds for svr-runner to be ready..."
          sleep 45

      - name: Setup Tailscale with fixed hostname
        run: |
          # CÃ i tá»« package manager
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y tailscale

          # Connect vá»›i hostname cá»‘ Ä‘á»‹nh: cli-runner
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=cli-runner
          sleep 5

      - name: Get Tailscale info
        run: |
          TS_IP=$(tailscale ip -4)
          TS_HOSTNAME=$(tailscale status --self | awk '{print $2}')
          echo "ğŸ’» Client Hostname: $TS_HOSTNAME"
          echo "ğŸ’» Client IP: $TS_IP"

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y rsync sshpass openssh-client netcat-openbsd dnsutils

      - name: Wait for svr-runner to be online
        run: |
          echo "ğŸ” Waiting for svr-runner to appear in Tailscale network..."

          for attempt in {1..30}; do
            echo "Attempt $attempt/30..."
            sleep 5
            
            sudo tailscale status
            
            # Kiá»ƒm tra svr-runner cÃ³ online khÃ´ng
            if sudo tailscale status | grep 'svr-runner' | grep -qv 'offline'; then
              echo "ğŸ¯ Found svr-runner (ONLINE)!"
              
              # Verify hostname resolution
              echo ""
              echo "Testing hostname resolution..."
              if nslookup svr-runner 2>/dev/null | grep -q "Address"; then
                echo "âœ“ Hostname svr-runner resolves via DNS"
              fi
              
              # Ping báº±ng hostname
              echo ""
              echo "Testing ping to svr-runner..."
              if ping -c 2 svr-runner 2>&1 | grep -q "bytes from"; then
                echo "âœ“ Can ping svr-runner by hostname"
              fi
              
              exit 0
            fi
            
            echo "svr-runner not online yet, retrying..."
          done

          echo "âŒ Failed to find online svr-runner after 30 attempts"
          exit 1

      - name: Test connectivity using hostname
        run: |
          echo "ğŸ“ Testing ping to svr-runner (hostname)..."
          ping -c 5 svr-runner

          echo ""
          echo "ğŸ”Œ Testing SSH port on svr-runner..."
          for i in {1..30}; do
            if nc -zv -w 5 svr-runner 22 2>&1 | grep -q succeeded; then
              echo "âœ“ SSH port is open on svr-runner!"
              break
            fi
            echo "Attempt $i/30 - waiting for SSH on svr-runner..."
            sleep 5
          done

      - name: Create client test data
        run: |
          mkdir -p ~/client-data
          echo "Hello from Client (cli-runner)" > ~/client-data/client-file.txt
          echo "Client timestamp: $(date)" > ~/client-data/client-timestamp.txt
          echo "Hostname: $(hostname)" > ~/client-data/hostname.txt
          echo "Test data from client: $RANDOM" > ~/client-data/test.txt
          dd if=/dev/urandom of=~/client-data/client-binary.dat bs=1M count=3 2>/dev/null

          ls -lh ~/client-data/
          echo "âœ“ Client test files created"

      - name: Sync files TO server using hostname
        env:
          SSHPASS: testpass123
        run: |
          echo "ğŸ“¤ Syncing files TO svr-runner (using hostname)..."
          echo "From: ~/client-data/"
          echo "To: runner@svr-runner:~/client-data/"

          sshpass -e rsync -avz --progress \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ~/client-data/ \
            runner@svr-runner:~/client-data/

          echo "âœ“ Push sync completed"

      - name: Sync files FROM server using hostname
        env:
          SSHPASS: testpass123
        run: |
          echo "ğŸ“¥ Syncing files FROM svr-runner (using hostname)..."
          echo "From: runner@svr-runner:~/server-data/"
          echo "To: ~/server-data/"

          mkdir -p ~/server-data

          sshpass -e rsync -avz --progress \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            runner@svr-runner:~/server-data/ \
            ~/server-data/

          echo "âœ“ Pull sync completed"

      - name: Verify synced data
        run: |
          echo "=== Files synced FROM svr-runner ==="
          ls -lh ~/server-data/
          echo ""
          echo "Content of text files:"
          cat ~/server-data/*.txt 2>/dev/null || true

          echo ""
          echo "=== Summary ==="
          echo "Client data sent: $(du -sh ~/client-data/ | awk '{print $1}')"
          echo "Server data received: $(du -sh ~/server-data/ | awk '{print $1}')"

      - name: Test bidirectional sync using hostname
        env:
          SSHPASS: testpass123
        run: |
          echo "ğŸ”„ Testing bidirectional sync with svr-runner..."

          # Táº¡o thÃªm file má»›i
          echo "Additional file created at $(date)" > ~/client-data/additional.txt

          # Sync láº¡i
          sshpass -e rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ~/client-data/ \
            runner@svr-runner:~/client-data/

          echo "âœ“ Bidirectional sync test completed"

      - name: Test remote command execution
        env:
          SSHPASS: testpass123
        run: |
          echo "ğŸ”§ Testing remote command execution on svr-runner..."

          # Execute commands on server
          sshpass -e ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            runner@svr-runner \
            "echo 'Remote command test'; hostname; date; ls -la ~/client-data/ | head -5"

          echo "âœ“ Remote command executed successfully"

      - name: Keep connection alive
        env:
          SSHPASS: testpass123
        run: |
          echo "ğŸ”„ Keeping connection alive for 5 minutes..."
          echo "Periodic syncs to svr-runner to maintain activity..."

          for i in {1..60}; do
            if [ $((i % 12)) -eq 0 ]; then
              echo "â±ï¸  Alive check $i/60 - $(date)"
              
              # Ping Ä‘á»ƒ giá»¯ connection
              ping -c 2 svr-runner > /dev/null 2>&1 || true
              
              # Sync nháº¹ Ä‘á»ƒ giá»¯ activity
              echo "Sync check at $(date)" > ~/client-data/keepalive.txt
              sshpass -e rsync -az \
                -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
                ~/client-data/keepalive.txt \
                runner@svr-runner:~/client-data/ 2>/dev/null || true
            fi
            sleep 5
          done

      - name: Final summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… CLIENT (cli-runner) FINAL SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Server hostname: svr-runner"
          echo "Client hostname: cli-runner"
          echo "Client IP: $(tailscale ip -4)"
          echo ""
          echo "âœ“ Tailscale network established"
          echo "âœ“ Hostname resolution working"
          echo "âœ“ Ping test (hostname) successful"
          echo "âœ“ SSH connection (hostname) successful"
          echo "âœ“ Rsync push (cli-runner â†’ svr-runner) successful"
          echo "âœ“ Rsync pull (svr-runner â†’ cli-runner) successful"
          echo "âœ“ Bidirectional sync verified"
          echo "âœ“ Remote command execution successful"
          echo "âœ“ Connection kept alive"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
