name: Tailscale Runner Test

on:
  workflow_dispatch:

jobs:
  # Job 1: Server runner - nháº­n dá»¯ liá»‡u
  server-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-server-${{ github.run_id }}
          sleep 5

      - name: Get Tailscale IP
        id: ts-ip
        run: |
          TS_IP=$(tailscale ip -4)
          echo "ip=$TS_IP" >> $GITHUB_OUTPUT
          echo "ğŸ–¥ï¸  Server Tailscale IP: $TS_IP"

          # LÆ°u IP vÃ o file Ä‘á»ƒ client cÃ³ thá»ƒ Ä‘á»c
          mkdir -p /tmp/share
          echo "$TS_IP" > /tmp/share/server-ip.txt

      - name: Setup SSH Server
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y openssh-server rsync

          # Táº¡o user vÃ  password Ä‘Æ¡n giáº£n cho test
          echo "runner:testpass123" | sudo chpasswd

          # Configure SSH Ä‘á»ƒ cho phÃ©p password login
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

          echo "âœ“ SSH server started on port 22"

      - name: Create test data
        run: |
          mkdir -p ~/server-data
          echo "Hello from Server Runner" > ~/server-data/server-file.txt
          echo "Server timestamp: $(date)" > ~/server-data/timestamp.txt
          echo "Random data: $RANDOM-$RANDOM-$RANDOM" > ~/server-data/random.txt
          dd if=/dev/urandom of=~/server-data/binary-test.dat bs=1M count=5 2>/dev/null

          ls -lh ~/server-data/
          echo "âœ“ Test files created"

      - name: Show network info
        run: |
          echo "=== Tailscale Status ==="
          sudo tailscale status
          echo ""
          echo "=== IP Addresses ==="
          ip addr show tailscale0
          echo ""
          echo "=== Listening ports ==="
          sudo netstat -tlnp | grep ssh

      - name: Keep server alive and monitor
        run: |
          echo "ğŸŸ¢ Server is ready and waiting for client connection..."
          echo "Server IP: $(tailscale ip -4)"
          echo "Monitoring for 15 minutes..."

          # Monitor logs trong 15 phÃºt
          for i in {1..180}; do
            if [ $((i % 12)) -eq 0 ]; then
              echo "â±ï¸  Alive [$i/180] - $(date)"
              echo "Connected peers:"
              sudo tailscale status --peers
            fi
            sleep 5
          done

      - name: Show final results
        if: always()
        run: |
          echo "=== Final Status ==="
          echo "Files in server-data:"
          ls -lh ~/server-data/ 2>/dev/null || true
          echo ""
          echo "Files received in client-data:"
          ls -lh ~/client-data/ 2>/dev/null || true
          if [ -d ~/client-data ]; then
            echo ""
            echo "Content of received files:"
            cat ~/client-data/*.txt 2>/dev/null || true
          fi

  # Job 2: Client runner - gá»­i dá»¯ liá»‡u
  client-runner:
    runs-on: ubuntu-latest
    needs: server-runner
    if: always()
    steps:
      - name: Wait for server startup
        run: |
          echo "â³ Waiting 30 seconds for server to be ready..."
          sleep 30

      - name: Setup Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-client-${{ github.run_id }}
          sleep 5

      - name: Get Tailscale IP
        run: |
          TS_IP=$(tailscale ip -4)
          echo "ğŸ’» Client Tailscale IP: $TS_IP"

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y rsync sshpass openssh-client netcat-openbsd

      - name: Discover server
        id: discover
        run: |
          echo "ğŸ” Discovering Tailscale peers..."
          sleep 10

          sudo tailscale status

          # Láº¥y IP cá»§a server (peer Ä‘áº§u tiÃªn khÃ´ng pháº£i chÃ­nh mÃ¬nh)
          SERVER_IP=$(sudo tailscale status | grep 'github-server' | awk '{print $1}')

          if [ -z "$SERVER_IP" ]; then
            echo "âš ï¸  No server found, trying alternative method..."
            sleep 10
            SERVER_IP=$(sudo tailscale status | grep -v $(hostname) | grep -v '^#' | head -1 | awk '{print $1}')
          fi

          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Found server at: $SERVER_IP"

      - name: Test connectivity
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
        run: |
          echo "ğŸ“ Testing ping to $SERVER_IP..."
          ping -c 5 $SERVER_IP

          echo ""
          echo "ğŸ”Œ Testing SSH port (22)..."
          for i in {1..30}; do
            if nc -zv -w 5 $SERVER_IP 22 2>&1 | grep -q succeeded; then
              echo "âœ“ SSH port is open!"
              break
            fi
            echo "Attempt $i/30 - waiting for SSH..."
            sleep 5
          done

      - name: Create client test data
        run: |
          mkdir -p ~/client-data
          echo "Hello from Client Runner" > ~/client-data/client-file.txt
          echo "Client timestamp: $(date)" > ~/client-data/client-timestamp.txt
          echo "Test data from client: $RANDOM" > ~/client-data/test.txt
          dd if=/dev/urandom of=~/client-data/client-binary.dat bs=1M count=3 2>/dev/null

          ls -lh ~/client-data/
          echo "âœ“ Client test files created"

      - name: Sync files TO server (rsync push)
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
          SSHPASS: testpass123
        run: |
          echo "ğŸ“¤ Syncing files TO server..."
          echo "From: ~/client-data/"
          echo "To: runner@$SERVER_IP:~/client-data/"

          sshpass -e rsync -avz --progress \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ~/client-data/ \
            runner@$SERVER_IP:~/client-data/

          echo "âœ“ Push sync completed"

      - name: Sync files FROM server (rsync pull)
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
          SSHPASS: testpass123
        run: |
          echo "ğŸ“¥ Syncing files FROM server..."
          echo "From: runner@$SERVER_IP:~/server-data/"
          echo "To: ~/server-data/"

          mkdir -p ~/server-data

          sshpass -e rsync -avz --progress \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            runner@$SERVER_IP:~/server-data/ \
            ~/server-data/

          echo "âœ“ Pull sync completed"

      - name: Verify synced data
        run: |
          echo "=== Files synced FROM server ==="
          ls -lh ~/server-data/
          echo ""
          echo "Content of text files:"
          cat ~/server-data/*.txt 2>/dev/null || true

          echo ""
          echo "=== Summary ==="
          echo "Client data sent: $(du -sh ~/client-data/ | awk '{print $1}')"
          echo "Server data received: $(du -sh ~/server-data/ | awk '{print $1}')"

      - name: Test bidirectional sync
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
          SSHPASS: testpass123
        run: |
          echo "ğŸ”„ Testing bidirectional sync..."

          # Táº¡o thÃªm file má»›i
          echo "Additional file created at $(date)" > ~/client-data/additional.txt

          # Sync láº¡i
          sshpass -e rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ~/client-data/ \
            runner@$SERVER_IP:~/client-data/

          echo "âœ“ Bidirectional sync test completed"

      - name: Final summary
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… TAILSCALE SYNC TEST SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Server IP: $SERVER_IP"
          echo "Client IP: $(tailscale ip -4)"
          echo ""
          echo "âœ“ Tailscale network established"
          echo "âœ“ Ping test successful"
          echo "âœ“ SSH connection successful"
          echo "âœ“ Rsync push (client â†’ server) successful"
          echo "âœ“ Rsync pull (server â†’ client) successful"
          echo "âœ“ Bidirectional sync verified"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
