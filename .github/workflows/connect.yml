name: Tailscale Runner Test

on:
  workflow_dispatch:

jobs:
  # Job 1: Server runner - nháº­n dá»¯ liá»‡u (cháº¡y song song)
  server-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Tailscale (cached)
        run: |
          # CÃ i tá»« package manager (nhanh hÆ¡n script)
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-server-${{ github.run_id }}
          sleep 5

      - name: Get Tailscale IP
        id: ts-ip
        run: |
          TS_IP=$(tailscale ip -4)
          echo "ip=$TS_IP" >> $GITHUB_OUTPUT
          echo "ğŸ–¥ï¸  Server Tailscale IP: $TS_IP"

      - name: Setup SSH Server
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y openssh-server rsync

          # Táº¡o user vÃ  password Ä‘Æ¡n giáº£n cho test
          echo "runner:testpass123" | sudo chpasswd

          # Configure SSH Ä‘á»ƒ cho phÃ©p password login
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

          echo "âœ“ SSH server started on port 22"

      - name: Create test data
        run: |
          mkdir -p ~/server-data
          echo "Hello from Server Runner" > ~/server-data/server-file.txt
          echo "Server timestamp: $(date)" > ~/server-data/timestamp.txt
          echo "Random data: $RANDOM-$RANDOM-$RANDOM" > ~/server-data/random.txt
          dd if=/dev/urandom of=~/server-data/binary-test.dat bs=1M count=5 2>/dev/null

          ls -lh ~/server-data/
          echo "âœ“ Test files created"

      - name: Show network info
        run: |
          echo "=== Tailscale Status ==="
          sudo tailscale status
          echo ""
          echo "=== IP Addresses ==="
          ip addr show tailscale0
          echo ""
          echo "=== Listening ports ==="
          sudo netstat -tlnp | grep ssh || echo "SSH not in netstat yet (OK)"
          sudo systemctl status ssh --no-pager || true

      - name: Wait for client and keep alive
        run: |
          echo "ğŸŸ¢ Server is ready and waiting for client connection..."
          echo "Server IP: $(tailscale ip -4)"
          echo "Waiting for client to connect (max 20 minutes)..."

          # Monitor logs vÃ  kiá»ƒm tra xem cÃ³ client connect khÃ´ng
          START_TIME=$(date +%s)
          CLIENT_CONNECTED=false

          for i in {1..240}; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            # Kiá»ƒm tra peers má»—i 30 giÃ¢y
            if [ $((i % 6)) -eq 0 ]; then
              echo "â±ï¸  [$ELAPSED seconds] Checking for peers..."
              PEER_COUNT=$(sudo tailscale status --peers | grep -c "github-client" || echo "0")
              
              if [ "$PEER_COUNT" -gt 0 ] && [ "$CLIENT_CONNECTED" = false ]; then
                echo "ğŸ‰ Client connected!"
                CLIENT_CONNECTED=true
              fi
              
              if [ "$CLIENT_CONNECTED" = true ]; then
                echo "âœ“ Active connection - peers online: $PEER_COUNT"
              fi
            fi
            
            # Kiá»ƒm tra xem cÃ³ file nÃ o Ä‘Æ°á»£c sync Ä‘áº¿n khÃ´ng
            if [ -d ~/client-data ] && [ "$(ls -A ~/client-data 2>/dev/null)" ]; then
              if [ "$CLIENT_CONNECTED" = false ]; then
                echo "ğŸ“¥ Received files from client!"
                ls -lh ~/client-data/
                CLIENT_CONNECTED=true
              fi
            fi
            
            sleep 5
          done

          echo "â° Timeout reached or sync completed"

      - name: Show final results
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š SERVER FINAL STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Server IP: $(tailscale ip -4)"
          echo ""
          echo "=== Files in server-data (original) ==="
          ls -lh ~/server-data/ 2>/dev/null || echo "No files"
          echo ""
          echo "=== Files received from client ==="
          if [ -d ~/client-data ]; then
            ls -lh ~/client-data/
            echo ""
            echo "Content of received text files:"
            cat ~/client-data/*.txt 2>/dev/null || echo "No text files"
          else
            echo "âŒ No files received from client"
          fi
          echo ""
          echo "=== Tailscale peers ==="
          sudo tailscale status --peers || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # Job 2: Client runner - gá»­i dá»¯ liá»‡u (cháº¡y song song)
  client-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for server startup
        run: |
          echo "â³ Waiting 45 seconds for server to be ready..."
          sleep 45

      - name: Setup Tailscale (cached)
        run: |
          # CÃ i tá»« package manager (nhanh hÆ¡n script)
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-client-${{ github.run_id }}
          sleep 5

      - name: Get Tailscale IP
        run: |
          TS_IP=$(tailscale ip -4)
          echo "ğŸ’» Client Tailscale IP: $TS_IP"

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y rsync sshpass openssh-client netcat-openbsd

      - name: Discover server (with retry)
        id: discover
        run: |
          echo "ğŸ” Discovering Tailscale peers..."

          # Retry logic Ä‘á»ƒ tÃ¬m server
          for attempt in {1..20}; do
            echo "Attempt $attempt/20..."
            sleep 5
            
            sudo tailscale status
            
            # Láº¥y IP cá»§a server ÄANG ONLINE (khÃ´ng cÃ³ "offline")
            SERVER_IP=$(sudo tailscale status | grep 'github-server' | grep -v 'offline' | awk '{print $1}' | head -1)
            
            if [ -n "$SERVER_IP" ]; then
              echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
              echo "ğŸ¯ Found ONLINE server at: $SERVER_IP"
              exit 0
            fi
            
            echo "No online server found yet, retrying..."
          done

          echo "âŒ Failed to discover online server after 20 attempts"
          exit 1

      - name: Test connectivity
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
        run: |
          echo "ğŸ“ Testing ping to $SERVER_IP..."
          ping -c 5 $SERVER_IP

          echo ""
          echo "ğŸ”Œ Testing SSH port (22)..."
          for i in {1..30}; do
            if nc -zv -w 5 $SERVER_IP 22 2>&1 | grep -q succeeded; then
              echo "âœ“ SSH port is open!"
              break
            fi
            echo "Attempt $i/30 - waiting for SSH..."
            sleep 5
          done

      - name: Create client test data
        run: |
          mkdir -p ~/client-data
          echo "Hello from Client Runner" > ~/client-data/client-file.txt
          echo "Client timestamp: $(date)" > ~/client-data/client-timestamp.txt
          echo "Test data from client: $RANDOM" > ~/client-data/test.txt
          dd if=/dev/urandom of=~/client-data/client-binary.dat bs=1M count=3 2>/dev/null

          ls -lh ~/client-data/
          echo "âœ“ Client test files created"

      - name: Sync files TO server (rsync push)
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
          SSHPASS: testpass123
        run: |
          echo "ğŸ“¤ Syncing files TO server..."
          echo "From: ~/client-data/"
          echo "To: runner@$SERVER_IP:~/client-data/"

          sshpass -e rsync -avz --progress \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ~/client-data/ \
            runner@$SERVER_IP:~/client-data/

          echo "âœ“ Push sync completed"

      - name: Sync files FROM server (rsync pull)
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
          SSHPASS: testpass123
        run: |
          echo "ğŸ“¥ Syncing files FROM server..."
          echo "From: runner@$SERVER_IP:~/server-data/"
          echo "To: ~/server-data/"

          mkdir -p ~/server-data

          sshpass -e rsync -avz --progress \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            runner@$SERVER_IP:~/server-data/ \
            ~/server-data/

          echo "âœ“ Pull sync completed"

      - name: Verify synced data
        run: |
          echo "=== Files synced FROM server ==="
          ls -lh ~/server-data/
          echo ""
          echo "Content of text files:"
          cat ~/server-data/*.txt 2>/dev/null || true

          echo ""
          echo "=== Summary ==="
          echo "Client data sent: $(du -sh ~/client-data/ | awk '{print $1}')"
          echo "Server data received: $(du -sh ~/server-data/ | awk '{print $1}')"

      - name: Test bidirectional sync
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
          SSHPASS: testpass123
        run: |
          echo "ğŸ”„ Testing bidirectional sync..."

          # Táº¡o thÃªm file má»›i
          echo "Additional file created at $(date)" > ~/client-data/additional.txt

          # Sync láº¡i
          sshpass -e rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ~/client-data/ \
            runner@$SERVER_IP:~/client-data/

          echo "âœ“ Bidirectional sync test completed"

      - name: Keep connection alive
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
          SSHPASS: testpass123
        run: |
          echo "ğŸ”„ Keeping connection alive for 5 minutes..."
          echo "Performing periodic syncs to ensure server stays up..."

          for i in {1..60}; do
            if [ $((i % 12)) -eq 0 ]; then
              echo "â±ï¸  Alive check $i/60 - $(date)"
              
              # Ping Ä‘á»ƒ giá»¯ connection
              ping -c 2 $SERVER_IP > /dev/null 2>&1 || true
              
              # Sync nháº¹ Ä‘á»ƒ giá»¯ activity
              echo "Sync check at $(date)" > ~/client-data/keepalive.txt
              sshpass -e rsync -az \
                -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
                ~/client-data/keepalive.txt \
                runner@$SERVER_IP:~/client-data/ 2>/dev/null || true
            fi
            sleep 5
          done

      - name: Final summary
        if: always()
        env:
          SERVER_IP: ${{ steps.discover.outputs.server_ip }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… CLIENT FINAL SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Server IP: $SERVER_IP"
          echo "Client IP: $(tailscale ip -4)"
          echo ""
          echo "âœ“ Tailscale network established"
          echo "âœ“ Ping test successful"
          echo "âœ“ SSH connection successful"
          echo "âœ“ Rsync push (client â†’ server) successful"
          echo "âœ“ Rsync pull (server â†’ client) successful"
          echo "âœ“ Bidirectional sync verified"
          echo "âœ“ Connection kept alive"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
